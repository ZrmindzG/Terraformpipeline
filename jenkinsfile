pipeline {
    agent any

    environment {
        TF_CLI_ARGS = "-input=false"
        TF_WORKSPACE = "default"
    }

    stages {
        stage('Install Terraform') {
            steps {
                script {
                    // Install Terraform
                    sh 'curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg'
                    sh 'echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list > /dev/null'
                    sh 'sudo apt-get update && sudo apt-get install terraform'
                }
            }
        }

        stage('Terraform Init') {
            steps {
                script {
                    // Initialize Terraform
                    sh 'terraform init -input=false'
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                script {
                    // Generate Terraform plan
                    sh 'terraform plan -out=tfplan -input=false'
                }
            }
        }

        stage('Manual Approval') {
            steps {
                input 'Do you want to apply the Terraform plan?'
            }
        }

        stage('Terraform Apply') {
            steps {
                script {
                    // Apply Terraform plan
                    sh 'terraform apply -input=false tfplan'
                }
            }
        }
    }

    post {
        always {
            // Clean up workspace or perform any post-build actions
        }
    }
}
